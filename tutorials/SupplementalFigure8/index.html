
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Comprehensive project documentation for scVIDR.">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>SupplementalFigure8 - scVIDR</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../assets/css/custom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#scvidr-rat-results" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="scVIDR" class="md-header__button md-logo" aria-label="scVIDR" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            scVIDR
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SupplementalFigure8
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../installation/getting-started/" class="md-tabs__link">
        
  
  
    
  
  Installation

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../API/API-introduction/" class="md-tabs__link">
        
  
  
    
  
  API

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../tutorials-introduction/" class="md-tabs__link">
        
  
  
    
  
  Tutorial

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="scVIDR" class="md-nav__button md-logo" aria-label="scVIDR" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    scVIDR
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../API/API-introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials-introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tutorial
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scvidr-rat-results" class="md-nav__link">
    <span class="md-ellipsis">
      scVIDR Rat Results
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scgen-cross-species-results" class="md-nav__link">
    <span class="md-ellipsis">
      scGen Cross Species Results
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scgen-results-with-average-delta" class="md-nav__link">
    <span class="md-ellipsis">
      scGen Results with Average Delta
    </span>
  </a>
  
    <nav class="md-nav" aria-label="scGen Results with Average Delta">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scpregan-results" class="md-nav__link">
    <span class="md-ellipsis">
      scPreGAN Results
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cellot-prediction" class="md-nav__link">
    <span class="md-ellipsis">
      CellOT Prediction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supplementary-figure-8c" class="md-nav__link">
    <span class="md-ellipsis">
      Supplementary Figure 8C
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<div class="highlight"><pre><span></span><code><span class="c1">#Create Access to my code</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;../vidr/&#39;</span><span class="p">)</span>

<span class="c1">#Import hte vaedr functions we have created</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vidr</span><span class="w"> </span><span class="kn">import</span> <span class="n">VIDR</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PCAEval</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCAEval</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Import important modules</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">linalg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">spatial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">anndata</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnnData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statannotations.Annotator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="c1">#For calculating statistical distance</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geomloss</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pykeops</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pykeops</span>
<span class="n">pykeops</span><span class="o">.</span><span class="n">clean_pykeops</span><span class="p">()</span>          <span class="c1"># just in case old build files are still present</span>
<span class="n">pykeops</span><span class="o">.</span><span class="n">test_numpy_bindings</span><span class="p">()</span>    <span class="c1"># perform the compilation</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="n">sc</span><span class="o">.</span><span class="n">set_figure_params</span><span class="p">(</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span> <span class="n">frameon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;dark&quot;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">figdir</span> <span class="o">=</span> <span class="s2">&quot;../figures&quot;</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">KeOps</span><span class="o">]</span><span class="w"> </span><span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">kanaomar</span><span class="o">/</span><span class="p">.</span><span class="n">cache</span><span class="o">/</span><span class="n">keops2</span><span class="mf">.1.1</span><span class="o">/</span><span class="n">build_CUDA_VISIBLE_DEVICES_0_1_2_3</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">cleaned</span><span class="p">.</span>
<span class="o">[</span><span class="n">KeOps</span><span class="o">]</span><span class="w"> </span><span class="n">Compiling</span><span class="w"> </span><span class="n">cuda</span><span class="w"> </span><span class="n">jit</span><span class="w"> </span><span class="n">compiler</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">OK</span>
<span class="o">[</span><span class="n">pyKeOps</span><span class="o">]</span><span class="w"> </span><span class="n">Compiling</span><span class="w"> </span><span class="n">nvrtc</span><span class="w"> </span><span class="n">binder</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">OK</span>
<span class="o">[</span><span class="n">KeOps</span><span class="o">]</span><span class="w"> </span><span class="n">Generating</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">formula</span><span class="w"> </span><span class="n">Sum_Reduction</span><span class="p">((</span><span class="nf">Var</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="nf">Var</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">|</span><span class="p">(</span><span class="nf">Var</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="nf">Var</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">OK</span>
<span class="n">pyKeOps</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">numpy</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">working</span><span class="err">!</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="s2">&quot;../data/train_species.h5ad&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">adata</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">AnnData</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">n_obs</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="n">n_vars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">62114</span><span class="w"> </span><span class="err">×</span><span class="w"> </span><span class="mi">6619</span>
<span class="w">    </span><span class="n">obs</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;condition&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;species&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;individual&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;batch&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;louvain&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;n_counts&#39;</span>
<span class="w">    </span><span class="k">var</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gene_ids-0-0-0-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-1-0-0-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-2-0-0-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-0-1-0-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-1-1-0-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-2-1-0-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-0-0-1-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-1-0-1-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-2-0-1-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-0-1-1-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-1-1-1-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-2-1-1-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-3-1-1-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-0-0-0-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-1-0-0-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-2-0-0-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-0-1-0-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-1-1-0-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-2-1-0-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-0-0-1-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-1-0-1-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-2-0-1-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-0-1-1-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-1-1-1-1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gene_ids-2-1-1-1&#39;</span>
<span class="w">    </span><span class="n">uns</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;condition_colors&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;neighbors&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;species_colors&#39;</span>
<span class="w">    </span><span class="n">obsm</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;X_pca&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;X_umap&#39;</span>
<span class="w">    </span><span class="n">obsp</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;distances&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;connectivities&#39;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">species</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="nx">index</span>
<span class="nx">AAACCTGTCGGTCTAA</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="w">    </span><span class="nx">rabbit</span>
<span class="nx">AAACCTGTCTGTCCGT</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="w">    </span><span class="nx">rabbit</span>
<span class="nx">AAACGGGAGCCGATTT</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="w">    </span><span class="nx">rabbit</span>
<span class="nx">AAACGGGAGGCGCTCT</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="w">    </span><span class="nx">rabbit</span>
<span class="nx">AAACGGGCACAACGCC</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="mi">0</span><span class="w">    </span><span class="nx">rabbit</span>
<span class="w">                               </span><span class="o">...</span><span class="w">  </span>
<span class="nx">TTTGGTTGTGGGTATG</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="w">     </span><span class="nx">mouse</span>
<span class="nx">TTTGTCAAGCCCTAAT</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="w">     </span><span class="nx">mouse</span>
<span class="nx">TTTGTCAAGCTAAACA</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="w">     </span><span class="nx">mouse</span>
<span class="nx">TTTGTCACAGTTTACG</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="w">     </span><span class="nx">mouse</span>
<span class="nx">TTTGTCATCCGTTGTC</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="w">     </span><span class="nx">mouse</span>
<span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="nx">species</span><span class="p">,</span><span class="w"> </span><span class="nx">Length</span><span class="p">:</span><span class="w"> </span><span class="mi">62114</span><span class="p">,</span><span class="w"> </span><span class="nx">dtype</span><span class="p">:</span><span class="w"> </span><span class="nx">category</span>
<span class="nx">Categories</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nx">object</span><span class="p">):</span><span class="w"> </span><span class="p">[</span><span class="err">&#39;</span><span class="nx">mouse</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">pig</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">rabbit</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">rat</span><span class="err">&#39;</span><span class="p">]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># #Training model</span>
<span class="c1"># for cell in [&quot;rat&quot;, &quot;rabbit&quot;, &quot;pig&quot;]:</span>
<span class="c1">#     train_adata, test_adata = prepare_data(adata, &quot;species&quot;, &quot;condition&quot;, cell, &quot;LPS6&quot;, normalized = True)</span>
<span class="c1">#     vae = VIDR(train_adata, linear_decoder = False)</span>

<span class="c1">#     vae.train(</span>
<span class="c1">#     max_epochs=100,</span>
<span class="c1">#     batch_size=128,</span>
<span class="c1">#     early_stopping=True,</span>
<span class="c1">#     early_stopping_patience=25)</span>
<span class="c1">#     vae.save(f&quot;../../data/VAE_Species_Prediction_LPS_7000g_{cell}.pt&quot;, overwrite = True)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">cell</span> <span class="o">=</span> <span class="s2">&quot;rat&quot;</span>
<span class="n">train_adata</span><span class="p">,</span> <span class="n">test_adata</span> <span class="o">=</span> <span class="n">prepare_data</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">vae</span> <span class="o">=</span> <span class="n">VIDR</span><span class="p">(</span><span class="n">train_adata</span><span class="p">,</span> <span class="n">linear_decoder</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">vae</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;../../data/VAE_Species_Prediction_LPS_7000g_</span><span class="si">{</span><span class="n">cell</span><span class="si">}</span><span class="s2">.pt/&quot;</span><span class="p">,</span> <span class="n">train_adata</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">batches</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;condition&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                 </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;species&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m52691</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Please</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">modify</span><span class="w"> </span><span class="n">adata</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">trained</span><span class="o">.</span><span class="w">                                                </span>
<span class="n">None</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Registered</span><span class="w"> </span><span class="n">keys</span><span class="p">:</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;X&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;batch_indices&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_mean&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_var&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;labels&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                           </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m52691</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="n">None</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">jaccard_similarity</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> 
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">C</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">jaccard_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">C</span><span class="p">,</span><span class="n">C</span><span class="p">])</span>
<span class="n">all_cts</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cell_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_cts</span><span class="p">):</span>
    <span class="n">CD4T</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">==</span><span class="n">cell_i</span><span class="p">]</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">CD4T</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;wilcoxon&quot;</span><span class="p">)</span>
    <span class="n">diff_genes_i</span> <span class="o">=</span> <span class="n">CD4T</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;rank_genes_groups&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="s2">&quot;LPS6&quot;</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">jdx</span><span class="p">,</span> <span class="n">cell_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_cts</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cell_i</span><span class="p">,</span> <span class="n">cell_j</span><span class="p">)</span>
        <span class="n">CD4T</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">==</span><span class="n">cell_j</span><span class="p">]</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">CD4T</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;wilcoxon&quot;</span><span class="p">)</span>
        <span class="n">diff_genes_j</span> <span class="o">=</span> <span class="n">CD4T</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;rank_genes_groups&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="s2">&quot;LPS6&quot;</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span>

        <span class="n">sim</span> <span class="o">=</span> <span class="n">jaccard_similarity</span><span class="p">(</span><span class="n">diff_genes_i</span><span class="p">,</span> <span class="n">diff_genes_j</span><span class="p">)</span>
        <span class="n">jaccard_mat</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">jdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>rabbit rabbit
rabbit pig
rabbit rat
rabbit mouse
pig rabbit
pig pig
pig rat
pig mouse
rat rabbit
rat pig
rat rat
rat mouse
mouse rabbit
mouse pig
mouse rat
mouse mouse
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">jaccard_mat</span><span class="p">,</span> <span class="n">xticklabels</span> <span class="o">=</span> <span class="n">all_cts</span><span class="p">,</span> <span class="n">yticklabels</span> <span class="o">=</span> <span class="n">all_cts</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>&lt;seaborn.matrix.ClusterGrid at 0x2ba51e866400&gt;
</code></pre></div>

<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_8_1.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">jaccard_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cell_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_cts</span><span class="p">):</span>
    <span class="n">CD4T</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">==</span><span class="n">cell_i</span><span class="p">]</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">CD4T</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;wilcoxon&quot;</span><span class="p">)</span>
    <span class="n">diff_genes_i</span> <span class="o">=</span> <span class="n">CD4T</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;rank_genes_groups&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="s2">&quot;LPS6&quot;</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">jdx</span><span class="p">,</span> <span class="n">cell_j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_cts</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cell_i</span><span class="p">,</span> <span class="n">cell_j</span><span class="p">)</span>
        <span class="n">CD4T</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">==</span><span class="n">cell_j</span><span class="p">]</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">CD4T</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;wilcoxon&quot;</span><span class="p">)</span>
        <span class="n">diff_genes_j</span> <span class="o">=</span> <span class="n">CD4T</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;rank_genes_groups&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="s2">&quot;LPS6&quot;</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span>

        <span class="n">sim</span> <span class="o">=</span> <span class="n">jaccard_similarity</span><span class="p">(</span><span class="n">diff_genes_i</span><span class="p">,</span> <span class="n">diff_genes_j</span><span class="p">)</span>
        <span class="n">jaccard_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">cell_i</span><span class="p">,</span> <span class="n">cell_j</span><span class="p">,</span> <span class="n">sim</span><span class="p">])</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>rabbit rabbit
rabbit pig
rabbit rat
rabbit mouse
pig rabbit
pig pig
pig rat
pig mouse
rat rabbit
rat pig
rat rat
rat mouse
mouse rabbit
mouse pig
mouse rat
mouse mouse
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">jaccard_df_narrow</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">jaccard_list</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Cell Type&quot;</span><span class="p">,</span> <span class="s2">&quot;Cell B&quot;</span><span class="p">,</span> <span class="s2">&quot;Jaccard Similarity&quot;</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">filt_df</span> <span class="o">=</span> <span class="n">jaccard_df_narrow</span><span class="p">[</span><span class="n">jaccard_df_narrow</span><span class="p">[</span><span class="s2">&quot;Jaccard Similarity&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;Cell Type&quot;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;Jaccard Similarity&quot;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">filt_df</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span> <span class="o">=</span> <span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Species&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>Text(0.5, 0, &#39;Species&#39;)
</code></pre></div>

<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_12_1.png" /></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">#UMAP Projection of latent space</span>
<span class="n">latent_X</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">get_latent_representation</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="n">latent_adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">latent_X</span><span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="n">adata</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">setup</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">scvi</span><span class="o">.</span><span class="w"> </span><span class="n">attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">transfer</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">setup</span><span class="w">                                     </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Registered</span><span class="w"> </span><span class="n">keys</span><span class="p">:</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;X&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;batch_indices&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_mean&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_var&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;labels&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                           </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m62114</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">latent_adata</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">latent_adata</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">WARNING</span><span class="o">:</span><span class="w"> </span><span class="n">You</span><span class="err">’</span><span class="n">re</span><span class="w"> </span><span class="n">trying</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">dimensions</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="err">`</span><span class="o">.</span><span class="na">X</span><span class="err">`</span><span class="o">,</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">really</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="k">this</span><span class="o">,</span><span class="w"> </span><span class="kd">set</span><span class="w"> </span><span class="err">`</span><span class="n">use_rep</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="err">`</span><span class="o">.</span>
<span class="w">         </span><span class="n">Falling</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">preprocessing</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="err">`</span><span class="n">sc</span><span class="o">.</span><span class="na">pp</span><span class="o">.</span><span class="na">pca</span><span class="err">`</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">params</span><span class="o">.</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">latent_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Training Split&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span><span class="s2">&quot;Test&quot;</span> <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;rat&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">))</span> <span class="k">else</span> <span class="s2">&quot;Train&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">latent_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span> <span class="n">latent_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">])]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">ax</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">latent_adata</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">],</span>
    <span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.45</span><span class="p">,</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Species&quot;</span>
<span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_17_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">ax</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">latent_adata</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">],</span>
    <span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.45</span><span class="p">,</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Condition&quot;</span>
<span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_18_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">ax</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">latent_adata</span><span class="p">,</span>
    <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Training Split&quot;</span><span class="p">],</span>
    <span class="n">palette</span> <span class="o">=</span> <span class="s2">&quot;Dark2&quot;</span><span class="p">,</span>
    <span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.45</span>
<span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_19_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">ctrl_key</span> <span class="o">=</span> <span class="s2">&quot;unst&quot;</span>
<span class="n">treat_key</span> <span class="o">=</span> <span class="s2">&quot;LPS6&quot;</span>
<span class="n">cell_type_to_predict</span> <span class="o">=</span> <span class="s2">&quot;rat&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">cell_type_key</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">scvi_setup_dict_</span><span class="p">[</span><span class="s2">&quot;categorical_mappings&quot;</span><span class="p">][</span><span class="s2">&quot;_scvi_labels&quot;</span><span class="p">][</span>
    <span class="s2">&quot;original_key&quot;</span>
<span class="p">]</span>
<span class="n">treatment_key</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">scvi_setup_dict_</span><span class="p">[</span><span class="s2">&quot;categorical_mappings&quot;</span><span class="p">][</span><span class="s2">&quot;_scvi_batch&quot;</span><span class="p">][</span>
    <span class="s2">&quot;original_key&quot;</span>
<span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">vae</span><span class="o">.</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species_condition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">condition</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">adata_bal</span> <span class="o">=</span> <span class="n">random_sample</span><span class="p">(</span><span class="n">vae</span><span class="o">.</span><span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;species_condition&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">)</span>
<span class="n">adata_bal_ctrl</span> <span class="o">=</span> <span class="n">adata_bal</span><span class="p">[(</span><span class="n">adata_bal</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cell_type_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type_to_predict</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata_bal</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">treatment_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">ctrl_key</span><span class="p">)]</span>
<span class="n">latent_bal</span> <span class="o">=</span>  <span class="n">vae</span><span class="o">.</span><span class="n">get_latent_representation</span><span class="p">(</span><span class="n">adata_bal</span><span class="p">)</span>
<span class="n">latent_bal_adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">latent_bal</span><span class="p">,</span> <span class="n">obs</span> <span class="o">=</span> <span class="n">adata_bal</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="n">latent_cd</span> <span class="o">=</span> <span class="n">latent_bal_adata</span><span class="p">[(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cell_type_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type_to_predict</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">treatment_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">ctrl_key</span><span class="p">)]</span><span class="o">.</span><span class="n">X</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">#Get deltas and control centroids for each cell tpye in the training dataset</span>
<span class="n">deltas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">latent_centroids</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cell_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">latent_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cell_type_key</span><span class="p">])</span>
<span class="k">for</span> <span class="n">cell_i</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cell_i</span> <span class="o">!=</span> <span class="n">cell_type_to_predict</span><span class="p">:</span>
        <span class="n">latent_ctrl</span> <span class="o">=</span> <span class="n">latent_bal_adata</span><span class="p">[(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cell_type_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">treatment_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">ctrl_key</span><span class="p">)]</span><span class="o">.</span><span class="n">X</span>
        <span class="n">latent_treat</span> <span class="o">=</span> <span class="n">latent_bal_adata</span><span class="p">[(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cell_type_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">treatment_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">treat_key</span><span class="p">)]</span><span class="o">.</span><span class="n">X</span>
        <span class="n">deltas_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">latent_treat</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">latent_ctrl</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deltas_i</span><span class="p">)</span>
        <span class="n">latent_centroids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">latent_ctrl</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">reg</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">latent_centroids</span><span class="p">,</span> <span class="n">deltas</span><span class="p">)</span>
<span class="n">scvidr_delta</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">latent_cd</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
<h3 id="scvidr-rat-results">scVIDR Rat Results<a class="headerlink" href="#scvidr-rat-results" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">treat_pred</span> <span class="o">=</span> <span class="n">scvidr_delta</span> <span class="o">+</span> <span class="n">latent_cd</span>
<span class="n">predicted_cells</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">generative</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">treat_pred</span><span class="p">))[</span><span class="s2">&quot;px&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">predicted_cells</span> <span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">adata_bal_ctrl</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">var</span><span class="o">=</span><span class="n">adata_bal_ctrl</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">obsm</span><span class="o">=</span><span class="n">adata_bal_ctrl</span><span class="o">.</span><span class="n">obsm</span><span class="o">.</span><span class="n">copy</span><span class="p">(),)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pred&#39;</span>
<span class="n">ctrl_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unst&quot;</span><span class="p">))]</span>
<span class="n">treat_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">))]</span>
<span class="n">eval_adata2</span> <span class="o">=</span> <span class="n">ctrl_adata</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">treat_adata</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<span class="n">treatments</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">eval_adata2</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;unst&#39;</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Control&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LPS6&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;scVIDR&quot;</span><span class="p">)</span>
<span class="n">eval_adata2</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">treatments</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">eval_adata2</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">eval_adata2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;Treatment&quot;</span><span class="p">,</span> <span class="n">frameon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="s2">&quot;SF8B1.svg&quot;</span><span class="p">)</span>
<span class="n">CD4T</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">==</span><span class="n">cell</span><span class="p">]</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">CD4T</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;wilcoxon&quot;</span><span class="p">)</span>
<span class="n">diff_genes</span> <span class="o">=</span> <span class="n">CD4T</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;rank_genes_groups&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="s2">&quot;LPS6&quot;</span><span class="p">]</span>
<span class="n">r2_value</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">reg_mean_plot</span><span class="p">(</span>
<span class="n">eval_adata2</span><span class="p">,</span>
<span class="n">axis_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">},</span>
<span class="n">gene_list</span><span class="o">=</span><span class="n">diff_genes</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span>
<span class="n">top_100_genes</span> <span class="o">=</span> <span class="n">diff_genes</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span>
<span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;Predicted Expression&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;Real Expression&quot;</span><span class="p">},</span>
<span class="n">path_to_save</span><span class="o">=</span><span class="s2">&quot;../figures/SF8C1.svg&quot;</span><span class="p">,</span>
<span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;scVIDR&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">WARNING</span><span class="o">:</span><span class="w"> </span><span class="n">saving</span><span class="w"> </span><span class="n">figure</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">../</span><span class="n">figures</span><span class="o">/</span><span class="n">pcaSF8B1</span><span class="o">.</span><span class="na">svg</span>
</code></pre></div>

<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_26_1.png" /></p>
<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_26_2.png" /></p>
<h3 id="scgen-cross-species-results">scGen Cross Species Results<a class="headerlink" href="#scgen-cross-species-results" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">latent_mouse_cd</span> <span class="o">=</span> <span class="n">latent_bal_adata</span><span class="p">[(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cell_type_key</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mouse&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">treatment_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">ctrl_key</span><span class="p">)]</span><span class="o">.</span><span class="n">X</span>
<span class="n">latent_mouse_trt</span> <span class="o">=</span> <span class="n">latent_bal_adata</span><span class="p">[(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cell_type_key</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mouse&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">treatment_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">treat_key</span><span class="p">)]</span><span class="o">.</span><span class="n">X</span>

<span class="n">scgen_treat_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">latent_mouse_trt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">latent_mouse_cd</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">scgen_species_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">latent_cd</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">latent_mouse_cd</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">treat_pred</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">scgen_species_delta</span> <span class="o">+</span> <span class="n">latent_mouse_trt</span> <span class="o">+</span> <span class="n">scgen_treat_delta</span> <span class="o">+</span> <span class="n">latent_cd</span><span class="p">)</span>
<span class="n">predicted_cells</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">generative</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">treat_pred</span><span class="p">))[</span><span class="s2">&quot;px&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">predicted_cells</span> <span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">adata_bal_ctrl</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">var</span><span class="o">=</span><span class="n">adata_bal_ctrl</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">obsm</span><span class="o">=</span><span class="n">adata_bal_ctrl</span><span class="o">.</span><span class="n">obsm</span><span class="o">.</span><span class="n">copy</span><span class="p">(),)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pred&#39;</span>
<span class="n">ctrl_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unst&quot;</span><span class="p">))]</span>
<span class="n">treat_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">))]</span>
<span class="n">eval_adata2</span> <span class="o">=</span> <span class="n">ctrl_adata</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">treat_adata</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<span class="n">treatments</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">eval_adata2</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;unst&#39;</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Control&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LPS6&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;scGen&quot;</span><span class="p">)</span>
<span class="n">eval_adata2</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">treatments</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">eval_adata2</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">eval_adata2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;Treatment&quot;</span><span class="p">,</span> <span class="n">frameon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="s2">&quot;SF8B2.svg&quot;</span><span class="p">)</span>
<span class="n">CD4T</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">==</span><span class="n">cell</span><span class="p">]</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">CD4T</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;wilcoxon&quot;</span><span class="p">)</span>
<span class="n">diff_genes</span> <span class="o">=</span> <span class="n">CD4T</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;rank_genes_groups&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="s2">&quot;LPS6&quot;</span><span class="p">]</span>
<span class="n">r2_value</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">reg_mean_plot</span><span class="p">(</span>
<span class="n">eval_adata2</span><span class="p">,</span>
<span class="n">axis_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">},</span>
<span class="n">gene_list</span><span class="o">=</span><span class="n">diff_genes</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span>
<span class="n">top_100_genes</span> <span class="o">=</span> <span class="n">diff_genes</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span>
<span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;Predicted Expression&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;Real Expression&quot;</span><span class="p">},</span>
<span class="n">path_to_save</span><span class="o">=</span><span class="s2">&quot;../figures/SF8C2.svg&quot;</span><span class="p">,</span>
<span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;scGen&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">WARNING</span><span class="o">:</span><span class="w"> </span><span class="n">saving</span><span class="w"> </span><span class="n">figure</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">../</span><span class="n">figures</span><span class="o">/</span><span class="n">pcaSF8B2</span><span class="o">.</span><span class="na">svg</span>
</code></pre></div>

<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_29_1.png" /></p>
<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_29_2.png" /></p>
<h2 id="scgen-results-with-average-delta">scGen Results with Average Delta<a class="headerlink" href="#scgen-results-with-average-delta" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">latent_ctrl</span> <span class="o">=</span> <span class="n">latent_bal_adata</span><span class="p">[(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">treatment_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">ctrl_key</span><span class="p">)]</span><span class="o">.</span><span class="n">X</span>
<span class="n">latent_treat</span> <span class="o">=</span> <span class="n">latent_bal_adata</span><span class="p">[(</span><span class="n">latent_bal_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">treatment_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">treat_key</span><span class="p">)]</span><span class="o">.</span><span class="n">X</span>
<span class="n">scgen_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">latent_treat</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">latent_ctrl</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># latent_bal_adata[(latent_bal_adata.obs[treatment_key] == treat_key)].obs.species_condition.unique()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">treat_pred</span> <span class="o">=</span> <span class="n">scgen_delta</span> <span class="o">+</span> <span class="n">latent_cd</span>
<span class="n">predicted_cells</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">generative</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">treat_pred</span><span class="p">))[</span><span class="s2">&quot;px&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">predicted_cells</span> <span class="p">,</span> <span class="n">obs</span><span class="o">=</span><span class="n">adata_bal_ctrl</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">var</span><span class="o">=</span><span class="n">adata_bal_ctrl</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">obsm</span><span class="o">=</span><span class="n">adata_bal_ctrl</span><span class="o">.</span><span class="n">obsm</span><span class="o">.</span><span class="n">copy</span><span class="p">(),)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pred&#39;</span>
<span class="n">ctrl_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unst&quot;</span><span class="p">))]</span>
<span class="n">treat_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">))]</span>
<span class="n">eval_adata2</span> <span class="o">=</span> <span class="n">ctrl_adata</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">treat_adata</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<span class="n">treatments</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">eval_adata2</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;unst&#39;</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Control&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LPS6&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;scGen&quot;</span><span class="p">)</span>
<span class="n">eval_adata2</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">treatments</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">eval_adata2</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">eval_adata2</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;Treatment&quot;</span><span class="p">,</span> <span class="n">frameon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="s2">&quot;SF8B2.svg&quot;</span><span class="p">)</span>
<span class="n">CD4T</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">==</span><span class="n">cell</span><span class="p">]</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">CD4T</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;wilcoxon&quot;</span><span class="p">)</span>
<span class="n">diff_genes</span> <span class="o">=</span> <span class="n">CD4T</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;rank_genes_groups&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="s2">&quot;LPS6&quot;</span><span class="p">]</span>
<span class="n">r2_value</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">reg_mean_plot</span><span class="p">(</span>
<span class="n">eval_adata2</span><span class="p">,</span>
<span class="n">axis_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">},</span>
<span class="n">gene_list</span><span class="o">=</span><span class="n">diff_genes</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span>
<span class="n">top_100_genes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;Predicted Expression&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;Real Expression&quot;</span><span class="p">},</span>
<span class="n">path_to_save</span><span class="o">=</span><span class="s2">&quot;../figures/SF8C2.svg&quot;</span><span class="p">,</span>
<span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;scGen&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">WARNING</span><span class="o">:</span><span class="w"> </span><span class="n">saving</span><span class="w"> </span><span class="n">figure</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">../</span><span class="n">figures</span><span class="o">/</span><span class="n">pcaSF8B2</span><span class="o">.</span><span class="na">svg</span>
</code></pre></div>

<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_33_1.png" /></p>
<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_33_2.png" /></p>
<h3 id="scpregan-results">scPreGAN Results<a class="headerlink" href="#scpregan-results" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">scPreGAN</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">gan</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">gan</span><span class="o">.</span><span class="n">load_anndata</span><span class="p">(</span><span class="n">data_path</span><span class="o">=</span><span class="s2">&quot;../data/train_species.h5ad&quot;</span><span class="p">,</span>
            <span class="n">condition_key</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span>
            <span class="n">condition</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;control&quot;</span><span class="p">:</span><span class="s2">&quot;unst&quot;</span><span class="p">,</span> <span class="s2">&quot;case&quot;</span><span class="p">:</span><span class="s2">&quot;LPS6&quot;</span><span class="p">},</span>
            <span class="n">cell_type_key</span><span class="o">=</span><span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="n">out_of_sample_prediction</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">prediction_cell_type</span><span class="o">=</span><span class="n">cell</span>
            <span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">Random</span><span class="w"> </span><span class="n">Seed</span><span class="p">:</span><span class="w">  </span><span class="mi">3060</span>
<span class="n">Successfully</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">model</span>
<span class="n">Successfully</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">model</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># #Training scPreGan</span>

<span class="c1"># gan.train(train_data = train_data)</span>

<span class="c1"># torch.save(gan.D_A.state_dict(), &quot;../data/gan_da_rat.pt&quot;)</span>
<span class="c1"># torch.save(gan.D_B.state_dict(), &quot;../data/gan_db_rat.pt&quot;)</span>
<span class="c1"># torch.save(gan.G_A.state_dict(), &quot;../data/gan_ga_rat.pt&quot;)</span>
<span class="c1"># torch.save(gan.G_B.state_dict(), &quot;../data/gan_gb_rat.pt&quot;)</span>
<span class="c1"># torch.save(gan.E.state_dict(), &quot;../data/gan_e_rat.pt&quot;)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[100/20000] adv_loss: -0.0238  recon_loss: 0.3465 encoding_loss: 0.0103 G_loss: 0.3330 D_A_loss: -108.1751  D_B_loss: -108.4284
[200/20000] adv_loss: -0.0382  recon_loss: 0.2965 encoding_loss: 0.0043 G_loss: 0.2626 D_A_loss: -93.5066  D_B_loss: -89.2510
[300/20000] adv_loss: -0.0352  recon_loss: 0.2698 encoding_loss: 0.0036 G_loss: 0.2381 D_A_loss: -84.6317  D_B_loss: -83.2130
[400/20000] adv_loss: -0.0327  recon_loss: 0.2668 encoding_loss: 0.0025 G_loss: 0.2366 D_A_loss: -78.1662  D_B_loss: -74.5129
[500/20000] adv_loss: -0.0302  recon_loss: 0.2525 encoding_loss: 0.0019 G_loss: 0.2242 D_A_loss: -73.4822  D_B_loss: -70.3501
[600/20000] adv_loss: -0.0206  recon_loss: 0.2416 encoding_loss: 0.0022 G_loss: 0.2232 D_A_loss: -69.2881  D_B_loss: -64.7405
[700/20000] adv_loss: -0.0243  recon_loss: 0.2421 encoding_loss: 0.0021 G_loss: 0.2200 D_A_loss: -63.4964  D_B_loss: -60.3896
[800/20000] adv_loss: -0.0142  recon_loss: 0.2307 encoding_loss: 0.0016 G_loss: 0.2180 D_A_loss: -58.9558  D_B_loss: -55.5171
[900/20000] adv_loss: -0.0167  recon_loss: 0.2193 encoding_loss: 0.0016 G_loss: 0.2042 D_A_loss: -53.7842  D_B_loss: -51.2267
[1000/20000] adv_loss: -0.0172  recon_loss: 0.2086 encoding_loss: 0.0015 G_loss: 0.1929 D_A_loss: -49.7916  D_B_loss: -47.0637
[1100/20000] adv_loss: -0.0074  recon_loss: 0.2126 encoding_loss: 0.0022 G_loss: 0.2073 D_A_loss: -48.4547  D_B_loss: -43.4780
[1200/20000] adv_loss: -0.0105  recon_loss: 0.2044 encoding_loss: 0.0017 G_loss: 0.1956 D_A_loss: -44.4699  D_B_loss: -41.5969
[1300/20000] adv_loss: -0.0097  recon_loss: 0.1957 encoding_loss: 0.0014 G_loss: 0.1873 D_A_loss: -42.3269  D_B_loss: -37.2285
[1400/20000] adv_loss: 0.0031  recon_loss: 0.2031 encoding_loss: 0.0048 G_loss: 0.2109 D_A_loss: -39.1141  D_B_loss: -36.2893
[1500/20000] adv_loss: -0.0001  recon_loss: 0.1947 encoding_loss: 0.0015 G_loss: 0.1960 D_A_loss: -36.5831  D_B_loss: -32.9490
[1600/20000] adv_loss: 0.0046  recon_loss: 0.1814 encoding_loss: 0.0026 G_loss: 0.1887 D_A_loss: -33.1014  D_B_loss: -31.7685
[1700/20000] adv_loss: 0.0033  recon_loss: 0.1914 encoding_loss: 0.0017 G_loss: 0.1964 D_A_loss: -30.6015  D_B_loss: -29.7046
[1800/20000] adv_loss: 0.0028  recon_loss: 0.1838 encoding_loss: 0.0016 G_loss: 0.1882 D_A_loss: -27.2895  D_B_loss: -27.7060
[1900/20000] adv_loss: 0.0073  recon_loss: 0.1853 encoding_loss: 0.0012 G_loss: 0.1938 D_A_loss: -25.7496  D_B_loss: -27.4963
[2000/20000] adv_loss: 0.0120  recon_loss: 0.1801 encoding_loss: 0.0017 G_loss: 0.1938 D_A_loss: -23.0978  D_B_loss: -25.4080
[2100/20000] adv_loss: 0.0227  recon_loss: 0.1789 encoding_loss: 0.0014 G_loss: 0.2030 D_A_loss: -23.0014  D_B_loss: -24.6750
[2200/20000] adv_loss: 0.0122  recon_loss: 0.1785 encoding_loss: 0.0015 G_loss: 0.1923 D_A_loss: -18.0069  D_B_loss: -24.2036
[2300/20000] adv_loss: 0.0081  recon_loss: 0.1817 encoding_loss: 0.0012 G_loss: 0.1910 D_A_loss: -16.8236  D_B_loss: -21.8153
[2400/20000] adv_loss: 0.0068  recon_loss: 0.1802 encoding_loss: 0.0016 G_loss: 0.1886 D_A_loss: -15.7430  D_B_loss: -22.1690
[2500/20000] adv_loss: 0.0139  recon_loss: 0.1768 encoding_loss: 0.0013 G_loss: 0.1921 D_A_loss: -14.6871  D_B_loss: -21.7059
[2600/20000] adv_loss: 0.0213  recon_loss: 0.1827 encoding_loss: 0.0016 G_loss: 0.2056 D_A_loss: -14.1933  D_B_loss: -21.2217
[2700/20000] adv_loss: 0.0211  recon_loss: 0.1820 encoding_loss: 0.0019 G_loss: 0.2051 D_A_loss: -13.6804  D_B_loss: -20.8790
[2800/20000] adv_loss: 0.0216  recon_loss: 0.1780 encoding_loss: 0.0014 G_loss: 0.2010 D_A_loss: -12.3563  D_B_loss: -19.8406
[2900/20000] adv_loss: 0.0245  recon_loss: 0.1719 encoding_loss: 0.0020 G_loss: 0.1983 D_A_loss: -13.1034  D_B_loss: -21.5601
[3000/20000] adv_loss: 0.0248  recon_loss: 0.1689 encoding_loss: 0.0021 G_loss: 0.1958 D_A_loss: -12.4081  D_B_loss: -19.2791
[3100/20000] adv_loss: 0.0251  recon_loss: 0.1713 encoding_loss: 0.0019 G_loss: 0.1983 D_A_loss: -11.9336  D_B_loss: -19.8580
[3200/20000] adv_loss: 0.0359  recon_loss: 0.1696 encoding_loss: 0.0020 G_loss: 0.2075 D_A_loss: -13.0851  D_B_loss: -19.3289
[3300/20000] adv_loss: 0.0331  recon_loss: 0.1698 encoding_loss: 0.0015 G_loss: 0.2044 D_A_loss: -11.5174  D_B_loss: -20.3864
[3400/20000] adv_loss: 0.0299  recon_loss: 0.1761 encoding_loss: 0.0021 G_loss: 0.2082 D_A_loss: -12.2965  D_B_loss: -19.8114
[3500/20000] adv_loss: 0.0365  recon_loss: 0.1668 encoding_loss: 0.0020 G_loss: 0.2054 D_A_loss: -12.1880  D_B_loss: -20.8127
[3600/20000] adv_loss: 0.0446  recon_loss: 0.1778 encoding_loss: 0.0018 G_loss: 0.2241 D_A_loss: -12.9537  D_B_loss: -20.7383
[3700/20000] adv_loss: 0.0391  recon_loss: 0.1748 encoding_loss: 0.0018 G_loss: 0.2158 D_A_loss: -12.7856  D_B_loss: -20.0384
[3800/20000] adv_loss: 0.0394  recon_loss: 0.1797 encoding_loss: 0.0027 G_loss: 0.2217 D_A_loss: -11.5444  D_B_loss: -20.3644
[3900/20000] adv_loss: 0.0469  recon_loss: 0.1769 encoding_loss: 0.0020 G_loss: 0.2258 D_A_loss: -12.6670  D_B_loss: -21.0934
[4000/20000] adv_loss: 0.0413  recon_loss: 0.1684 encoding_loss: 0.0015 G_loss: 0.2113 D_A_loss: -12.4237  D_B_loss: -21.4957
[4100/20000] adv_loss: 0.0453  recon_loss: 0.1784 encoding_loss: 0.0015 G_loss: 0.2252 D_A_loss: -12.1669  D_B_loss: -20.0435
[4200/20000] adv_loss: 0.0486  recon_loss: 0.1909 encoding_loss: 0.0017 G_loss: 0.2412 D_A_loss: -12.8943  D_B_loss: -21.8133
[4300/20000] adv_loss: 0.0462  recon_loss: 0.1792 encoding_loss: 0.0024 G_loss: 0.2277 D_A_loss: -12.5277  D_B_loss: -21.3984
[4400/20000] adv_loss: 0.0529  recon_loss: 0.1695 encoding_loss: 0.0018 G_loss: 0.2242 D_A_loss: -13.2052  D_B_loss: -21.8325
[4500/20000] adv_loss: 0.0513  recon_loss: 0.1768 encoding_loss: 0.0018 G_loss: 0.2299 D_A_loss: -12.3329  D_B_loss: -21.5632
[4600/20000] adv_loss: 0.0536  recon_loss: 0.1710 encoding_loss: 0.0020 G_loss: 0.2266 D_A_loss: -13.0512  D_B_loss: -21.6949
[4700/20000] adv_loss: 0.0534  recon_loss: 0.1695 encoding_loss: 0.0017 G_loss: 0.2246 D_A_loss: -12.6687  D_B_loss: -21.5501
[4800/20000] adv_loss: 0.0521  recon_loss: 0.1724 encoding_loss: 0.0019 G_loss: 0.2264 D_A_loss: -12.5512  D_B_loss: -21.9120
[4900/20000] adv_loss: 0.0558  recon_loss: 0.2056 encoding_loss: 0.0019 G_loss: 0.2634 D_A_loss: -12.3539  D_B_loss: -21.5966
[5000/20000] adv_loss: 0.0538  recon_loss: 0.1806 encoding_loss: 0.0018 G_loss: 0.2363 D_A_loss: -11.7618  D_B_loss: -20.3047
[5100/20000] adv_loss: 0.0556  recon_loss: 0.1780 encoding_loss: 0.0019 G_loss: 0.2355 D_A_loss: -11.9076  D_B_loss: -22.2701
[5200/20000] adv_loss: 0.0541  recon_loss: 0.1715 encoding_loss: 0.0023 G_loss: 0.2279 D_A_loss: -12.6001  D_B_loss: -22.1283
[5300/20000] adv_loss: 0.0590  recon_loss: 0.1835 encoding_loss: 0.0026 G_loss: 0.2451 D_A_loss: -12.3211  D_B_loss: -21.4763
[5400/20000] adv_loss: 0.0584  recon_loss: 0.1840 encoding_loss: 0.0017 G_loss: 0.2440 D_A_loss: -12.1296  D_B_loss: -22.1303
[5500/20000] adv_loss: 0.0568  recon_loss: 0.1682 encoding_loss: 0.0014 G_loss: 0.2264 D_A_loss: -11.9058  D_B_loss: -21.7852
[5600/20000] adv_loss: 0.0578  recon_loss: 0.1708 encoding_loss: 0.0017 G_loss: 0.2302 D_A_loss: -12.2129  D_B_loss: -21.5865
[5700/20000] adv_loss: 0.0532  recon_loss: 0.1652 encoding_loss: 0.0017 G_loss: 0.2201 D_A_loss: -11.8861  D_B_loss: -21.3832
[5800/20000] adv_loss: 0.0592  recon_loss: 0.1800 encoding_loss: 0.0015 G_loss: 0.2407 D_A_loss: -11.8592  D_B_loss: -22.5028
[5900/20000] adv_loss: 0.0611  recon_loss: 0.1724 encoding_loss: 0.0018 G_loss: 0.2353 D_A_loss: -12.1742  D_B_loss: -21.7796
[6000/20000] adv_loss: 0.0581  recon_loss: 0.1852 encoding_loss: 0.0015 G_loss: 0.2447 D_A_loss: -12.2476  D_B_loss: -20.6969
[6100/20000] adv_loss: 0.0574  recon_loss: 0.1685 encoding_loss: 0.0015 G_loss: 0.2274 D_A_loss: -11.6020  D_B_loss: -21.1404
[6200/20000] adv_loss: 0.0557  recon_loss: 0.1648 encoding_loss: 0.0013 G_loss: 0.2218 D_A_loss: -11.5391  D_B_loss: -21.7059
[6300/20000] adv_loss: 0.0552  recon_loss: 0.1747 encoding_loss: 0.0022 G_loss: 0.2321 D_A_loss: -12.2373  D_B_loss: -22.0071
[6400/20000] adv_loss: 0.0548  recon_loss: 0.1797 encoding_loss: 0.0019 G_loss: 0.2364 D_A_loss: -12.1547  D_B_loss: -20.7848
[6500/20000] adv_loss: 0.0532  recon_loss: 0.1607 encoding_loss: 0.0019 G_loss: 0.2158 D_A_loss: -12.1215  D_B_loss: -21.3225
[6600/20000] adv_loss: 0.0538  recon_loss: 0.1740 encoding_loss: 0.0016 G_loss: 0.2294 D_A_loss: -12.9073  D_B_loss: -22.5973
[6700/20000] adv_loss: 0.0535  recon_loss: 0.1682 encoding_loss: 0.0012 G_loss: 0.2229 D_A_loss: -11.5948  D_B_loss: -22.3586
[6800/20000] adv_loss: 0.0605  recon_loss: 0.1753 encoding_loss: 0.0012 G_loss: 0.2370 D_A_loss: -11.5107  D_B_loss: -21.3939
[6900/20000] adv_loss: 0.0495  recon_loss: 0.1642 encoding_loss: 0.0016 G_loss: 0.2153 D_A_loss: -11.3190  D_B_loss: -21.5034
[7000/20000] adv_loss: 0.0492  recon_loss: 0.1729 encoding_loss: 0.0015 G_loss: 0.2236 D_A_loss: -10.7056  D_B_loss: -21.3990
[7100/20000] adv_loss: 0.0513  recon_loss: 0.1684 encoding_loss: 0.0015 G_loss: 0.2212 D_A_loss: -11.9519  D_B_loss: -21.0379
[7200/20000] adv_loss: 0.0475  recon_loss: 0.1684 encoding_loss: 0.0013 G_loss: 0.2172 D_A_loss: -11.7898  D_B_loss: -19.9595
[7300/20000] adv_loss: 0.0474  recon_loss: 0.1623 encoding_loss: 0.0016 G_loss: 0.2113 D_A_loss: -11.8793  D_B_loss: -20.9907
[7400/20000] adv_loss: 0.0469  recon_loss: 0.1792 encoding_loss: 0.0013 G_loss: 0.2273 D_A_loss: -11.8935  D_B_loss: -20.1690
[7500/20000] adv_loss: 0.0465  recon_loss: 0.1730 encoding_loss: 0.0015 G_loss: 0.2210 D_A_loss: -12.2184  D_B_loss: -21.4691
[7600/20000] adv_loss: 0.0469  recon_loss: 0.1640 encoding_loss: 0.0014 G_loss: 0.2123 D_A_loss: -11.1894  D_B_loss: -20.3001
[7700/20000] adv_loss: 0.0463  recon_loss: 0.1691 encoding_loss: 0.0015 G_loss: 0.2169 D_A_loss: -11.3900  D_B_loss: -21.5486
[7800/20000] adv_loss: 0.0454  recon_loss: 0.1744 encoding_loss: 0.0016 G_loss: 0.2215 D_A_loss: -11.6896  D_B_loss: -20.6187
[7900/20000] adv_loss: 0.0460  recon_loss: 0.1786 encoding_loss: 0.0017 G_loss: 0.2263 D_A_loss: -11.4558  D_B_loss: -20.7117
[8000/20000] adv_loss: 0.0413  recon_loss: 0.1665 encoding_loss: 0.0020 G_loss: 0.2098 D_A_loss: -11.4162  D_B_loss: -19.7117
[8100/20000] adv_loss: 0.0420  recon_loss: 0.1609 encoding_loss: 0.0016 G_loss: 0.2046 D_A_loss: -11.7241  D_B_loss: -20.1521
[8200/20000] adv_loss: 0.0450  recon_loss: 0.1668 encoding_loss: 0.0020 G_loss: 0.2138 D_A_loss: -11.6045  D_B_loss: -20.1455
[8300/20000] adv_loss: 0.0402  recon_loss: 0.1731 encoding_loss: 0.0015 G_loss: 0.2149 D_A_loss: -11.4212  D_B_loss: -19.9849
[8400/20000] adv_loss: 0.0406  recon_loss: 0.1678 encoding_loss: 0.0014 G_loss: 0.2098 D_A_loss: -11.7868  D_B_loss: -19.8300
[8500/20000] adv_loss: 0.0405  recon_loss: 0.1648 encoding_loss: 0.0020 G_loss: 0.2073 D_A_loss: -10.8320  D_B_loss: -19.2213
[8600/20000] adv_loss: 0.0402  recon_loss: 0.1709 encoding_loss: 0.0019 G_loss: 0.2130 D_A_loss: -11.3348  D_B_loss: -20.3355
[8700/20000] adv_loss: 0.0410  recon_loss: 0.1671 encoding_loss: 0.0015 G_loss: 0.2096 D_A_loss: -11.6441  D_B_loss: -19.3199
[8800/20000] adv_loss: 0.0379  recon_loss: 0.1740 encoding_loss: 0.0021 G_loss: 0.2140 D_A_loss: -11.8881  D_B_loss: -19.6553
[8900/20000] adv_loss: 0.0432  recon_loss: 0.1773 encoding_loss: 0.0018 G_loss: 0.2223 D_A_loss: -12.2151  D_B_loss: -21.6869
[9000/20000] adv_loss: 0.0394  recon_loss: 0.1639 encoding_loss: 0.0020 G_loss: 0.2052 D_A_loss: -11.4922  D_B_loss: -19.5311
[9100/20000] adv_loss: 0.0391  recon_loss: 0.1754 encoding_loss: 0.0025 G_loss: 0.2170 D_A_loss: -11.4344  D_B_loss: -20.0152
[9200/20000] adv_loss: 0.0395  recon_loss: 0.1729 encoding_loss: 0.0026 G_loss: 0.2150 D_A_loss: -10.6682  D_B_loss: -20.2429
[9300/20000] adv_loss: 0.0366  recon_loss: 0.1664 encoding_loss: 0.0021 G_loss: 0.2050 D_A_loss: -11.9154  D_B_loss: -20.4456
[9400/20000] adv_loss: 0.0358  recon_loss: 0.1666 encoding_loss: 0.0018 G_loss: 0.2042 D_A_loss: -11.9083  D_B_loss: -20.3259
[9500/20000] adv_loss: 0.0375  recon_loss: 0.1801 encoding_loss: 0.0031 G_loss: 0.2208 D_A_loss: -11.4016  D_B_loss: -19.6480
[9600/20000] adv_loss: 0.0350  recon_loss: 0.1813 encoding_loss: 0.0021 G_loss: 0.2184 D_A_loss: -12.2340  D_B_loss: -20.0809
[9700/20000] adv_loss: 0.0327  recon_loss: 0.1709 encoding_loss: 0.0024 G_loss: 0.2059 D_A_loss: -11.8934  D_B_loss: -20.2570
[9800/20000] adv_loss: 0.0357  recon_loss: 0.1629 encoding_loss: 0.0023 G_loss: 0.2008 D_A_loss: -11.5790  D_B_loss: -20.6521
[9900/20000] adv_loss: 0.0321  recon_loss: 0.1661 encoding_loss: 0.0022 G_loss: 0.2004 D_A_loss: -11.4205  D_B_loss: -19.7638
[10000/20000] adv_loss: 0.0350  recon_loss: 0.1704 encoding_loss: 0.0018 G_loss: 0.2073 D_A_loss: -11.7917  D_B_loss: -21.1067
[10100/20000] adv_loss: 0.0359  recon_loss: 0.1638 encoding_loss: 0.0021 G_loss: 0.2018 D_A_loss: -12.3479  D_B_loss: -19.1138
[10200/20000] adv_loss: 0.0339  recon_loss: 0.1625 encoding_loss: 0.0019 G_loss: 0.1983 D_A_loss: -10.9133  D_B_loss: -19.8377
[10300/20000] adv_loss: 0.0325  recon_loss: 0.1817 encoding_loss: 0.0019 G_loss: 0.2161 D_A_loss: -11.8474  D_B_loss: -20.7530
[10400/20000] adv_loss: 0.0302  recon_loss: 0.1761 encoding_loss: 0.0021 G_loss: 0.2084 D_A_loss: -11.3460  D_B_loss: -19.3849
[10500/20000] adv_loss: 0.0342  recon_loss: 0.1656 encoding_loss: 0.0023 G_loss: 0.2021 D_A_loss: -11.1505  D_B_loss: -19.6499
[10600/20000] adv_loss: 0.0315  recon_loss: 0.1692 encoding_loss: 0.0023 G_loss: 0.2030 D_A_loss: -11.6456  D_B_loss: -20.1447
[10700/20000] adv_loss: 0.0312  recon_loss: 0.1770 encoding_loss: 0.0036 G_loss: 0.2118 D_A_loss: -15.2892  D_B_loss: -22.5845
[10800/20000] adv_loss: 0.0275  recon_loss: 0.1752 encoding_loss: 0.0032 G_loss: 0.2059 D_A_loss: -11.3593  D_B_loss: -20.9051
[10900/20000] adv_loss: 0.0265  recon_loss: 0.1718 encoding_loss: 0.0018 G_loss: 0.2001 D_A_loss: -12.7211  D_B_loss: -21.2403
[11000/20000] adv_loss: 0.0271  recon_loss: 0.1670 encoding_loss: 0.0024 G_loss: 0.1964 D_A_loss: -10.9926  D_B_loss: -21.7853
[11100/20000] adv_loss: 0.0284  recon_loss: 0.1738 encoding_loss: 0.0030 G_loss: 0.2052 D_A_loss: -13.0072  D_B_loss: -21.4462
[11200/20000] adv_loss: 0.0281  recon_loss: 0.1744 encoding_loss: 0.0024 G_loss: 0.2049 D_A_loss: -12.0438  D_B_loss: -20.5864
[11300/20000] adv_loss: 0.0257  recon_loss: 0.1662 encoding_loss: 0.0023 G_loss: 0.1942 D_A_loss: -11.5773  D_B_loss: -20.2980
[11400/20000] adv_loss: 0.0287  recon_loss: 0.1738 encoding_loss: 0.0030 G_loss: 0.2055 D_A_loss: -13.6893  D_B_loss: -21.6739
[11500/20000] adv_loss: 0.0264  recon_loss: 0.1684 encoding_loss: 0.0028 G_loss: 0.1976 D_A_loss: -12.7059  D_B_loss: -21.7263
[11600/20000] adv_loss: 0.0261  recon_loss: 0.1630 encoding_loss: 0.0041 G_loss: 0.1932 D_A_loss: -11.7351  D_B_loss: -21.6808
[11700/20000] adv_loss: 0.0266  recon_loss: 0.1662 encoding_loss: 0.0036 G_loss: 0.1965 D_A_loss: -12.3227  D_B_loss: -21.3576
[11800/20000] adv_loss: 0.0240  recon_loss: 0.1752 encoding_loss: 0.0025 G_loss: 0.2016 D_A_loss: -11.8245  D_B_loss: -22.1777
[11900/20000] adv_loss: 0.0250  recon_loss: 0.1670 encoding_loss: 0.0023 G_loss: 0.1942 D_A_loss: -12.7580  D_B_loss: -20.9058
[12000/20000] adv_loss: 0.0266  recon_loss: 0.1716 encoding_loss: 0.0028 G_loss: 0.2010 D_A_loss: -11.5222  D_B_loss: -20.8387
[12100/20000] adv_loss: 0.0239  recon_loss: 0.1673 encoding_loss: 0.0024 G_loss: 0.1935 D_A_loss: -12.5051  D_B_loss: -21.4505
[12200/20000] adv_loss: 0.0235  recon_loss: 0.1609 encoding_loss: 0.0027 G_loss: 0.1870 D_A_loss: -11.5762  D_B_loss: -21.5789
[12300/20000] adv_loss: 0.0317  recon_loss: 0.1892 encoding_loss: 0.0040 G_loss: 0.2250 D_A_loss: -13.7001  D_B_loss: -22.7667
[12400/20000] adv_loss: 0.0259  recon_loss: 0.1778 encoding_loss: 0.0030 G_loss: 0.2067 D_A_loss: -12.8568  D_B_loss: -23.1269
[12500/20000] adv_loss: 0.0262  recon_loss: 0.1816 encoding_loss: 0.0024 G_loss: 0.2102 D_A_loss: -13.0925  D_B_loss: -20.8266
[12600/20000] adv_loss: 0.0223  recon_loss: 0.1750 encoding_loss: 0.0024 G_loss: 0.1998 D_A_loss: -13.2685  D_B_loss: -20.7516
[12700/20000] adv_loss: 0.0238  recon_loss: 0.1651 encoding_loss: 0.0025 G_loss: 0.1915 D_A_loss: -11.7419  D_B_loss: -21.9982
[12800/20000] adv_loss: 0.0282  recon_loss: 0.1745 encoding_loss: 0.0026 G_loss: 0.2052 D_A_loss: -13.2552  D_B_loss: -22.2194
[12900/20000] adv_loss: 0.0255  recon_loss: 0.1773 encoding_loss: 0.0038 G_loss: 0.2066 D_A_loss: -13.7069  D_B_loss: -21.7949
[13000/20000] adv_loss: 0.0272  recon_loss: 0.1736 encoding_loss: 0.0023 G_loss: 0.2031 D_A_loss: -13.0551  D_B_loss: -21.0294
[13100/20000] adv_loss: 0.0239  recon_loss: 0.1691 encoding_loss: 0.0024 G_loss: 0.1954 D_A_loss: -11.4410  D_B_loss: -21.5614
[13200/20000] adv_loss: 0.0240  recon_loss: 0.1765 encoding_loss: 0.0018 G_loss: 0.2023 D_A_loss: -11.4681  D_B_loss: -21.7203
[13300/20000] adv_loss: 0.0243  recon_loss: 0.1790 encoding_loss: 0.0019 G_loss: 0.2052 D_A_loss: -11.7007  D_B_loss: -20.7988
[13400/20000] adv_loss: 0.0255  recon_loss: 0.1660 encoding_loss: 0.0023 G_loss: 0.1938 D_A_loss: -11.6956  D_B_loss: -20.8346
[13500/20000] adv_loss: 0.0250  recon_loss: 0.1715 encoding_loss: 0.0026 G_loss: 0.1991 D_A_loss: -12.8404  D_B_loss: -22.1297
[13600/20000] adv_loss: 0.0255  recon_loss: 0.1718 encoding_loss: 0.0028 G_loss: 0.2001 D_A_loss: -10.6984  D_B_loss: -21.0549
[13700/20000] adv_loss: 0.0253  recon_loss: 0.1679 encoding_loss: 0.0022 G_loss: 0.1955 D_A_loss: -11.5727  D_B_loss: -21.6037
[13800/20000] adv_loss: 0.0251  recon_loss: 0.1766 encoding_loss: 0.0022 G_loss: 0.2039 D_A_loss: -13.0105  D_B_loss: -23.8891
[13900/20000] adv_loss: 0.0223  recon_loss: 0.1657 encoding_loss: 0.0024 G_loss: 0.1904 D_A_loss: -12.4314  D_B_loss: -22.2521
[14000/20000] adv_loss: 0.0231  recon_loss: 0.1635 encoding_loss: 0.0023 G_loss: 0.1889 D_A_loss: -12.1050  D_B_loss: -21.1881
[14100/20000] adv_loss: 0.0241  recon_loss: 0.1634 encoding_loss: 0.0025 G_loss: 0.1900 D_A_loss: -11.2742  D_B_loss: -20.8966
[14200/20000] adv_loss: 0.0310  recon_loss: 0.1773 encoding_loss: 0.0038 G_loss: 0.2121 D_A_loss: -13.9516  D_B_loss: -22.6594
[14300/20000] adv_loss: 0.0238  recon_loss: 0.1765 encoding_loss: 0.0024 G_loss: 0.2026 D_A_loss: -13.0705  D_B_loss: -21.1153
[14400/20000] adv_loss: 0.0270  recon_loss: 0.1706 encoding_loss: 0.0024 G_loss: 0.2001 D_A_loss: -11.5381  D_B_loss: -21.8381
[14500/20000] adv_loss: 0.0248  recon_loss: 0.1709 encoding_loss: 0.0024 G_loss: 0.1980 D_A_loss: -10.7628  D_B_loss: -21.0925
[14600/20000] adv_loss: 0.0256  recon_loss: 0.1690 encoding_loss: 0.0020 G_loss: 0.1966 D_A_loss: -12.3722  D_B_loss: -21.1659
[14700/20000] adv_loss: 0.0233  recon_loss: 0.1672 encoding_loss: 0.0025 G_loss: 0.1930 D_A_loss: -12.2467  D_B_loss: -20.9909
[14800/20000] adv_loss: 0.0284  recon_loss: 0.1745 encoding_loss: 0.0020 G_loss: 0.2049 D_A_loss: -11.7965  D_B_loss: -21.9676
[14900/20000] adv_loss: 0.0277  recon_loss: 0.1746 encoding_loss: 0.0022 G_loss: 0.2046 D_A_loss: -11.1138  D_B_loss: -20.4407
[15000/20000] adv_loss: 0.0257  recon_loss: 0.1714 encoding_loss: 0.0020 G_loss: 0.1991 D_A_loss: -12.1143  D_B_loss: -20.6258
[15100/20000] adv_loss: 0.0237  recon_loss: 0.1746 encoding_loss: 0.0035 G_loss: 0.2018 D_A_loss: -11.1458  D_B_loss: -20.8461
[15200/20000] adv_loss: 0.0307  recon_loss: 0.1718 encoding_loss: 0.0027 G_loss: 0.2052 D_A_loss: -12.9859  D_B_loss: -20.7232
[15300/20000] adv_loss: 0.0274  recon_loss: 0.1814 encoding_loss: 0.0032 G_loss: 0.2120 D_A_loss: -12.3387  D_B_loss: -22.6639
[15400/20000] adv_loss: 0.0243  recon_loss: 0.1686 encoding_loss: 0.0035 G_loss: 0.1964 D_A_loss: -12.3349  D_B_loss: -22.5876
[15500/20000] adv_loss: 0.0274  recon_loss: 0.1726 encoding_loss: 0.0023 G_loss: 0.2023 D_A_loss: -11.2997  D_B_loss: -20.7801
[15600/20000] adv_loss: 0.0289  recon_loss: 0.1663 encoding_loss: 0.0026 G_loss: 0.1978 D_A_loss: -12.0270  D_B_loss: -20.6875
[15700/20000] adv_loss: 0.0252  recon_loss: 0.1698 encoding_loss: 0.0019 G_loss: 0.1968 D_A_loss: -11.7578  D_B_loss: -20.0737
[15800/20000] adv_loss: 0.0241  recon_loss: 0.1662 encoding_loss: 0.0025 G_loss: 0.1928 D_A_loss: -11.8110  D_B_loss: -21.0124
[15900/20000] adv_loss: 0.0251  recon_loss: 0.1640 encoding_loss: 0.0022 G_loss: 0.1913 D_A_loss: -11.3624  D_B_loss: -20.9140
[16000/20000] adv_loss: 0.0270  recon_loss: 0.1680 encoding_loss: 0.0023 G_loss: 0.1973 D_A_loss: -11.9620  D_B_loss: -21.3198
[16100/20000] adv_loss: 0.0270  recon_loss: 0.1699 encoding_loss: 0.0025 G_loss: 0.1994 D_A_loss: -12.3831  D_B_loss: -20.5892
[16200/20000] adv_loss: 0.0282  recon_loss: 0.1677 encoding_loss: 0.0020 G_loss: 0.1978 D_A_loss: -12.7482  D_B_loss: -20.4608
[16300/20000] adv_loss: 0.0313  recon_loss: 0.1781 encoding_loss: 0.0030 G_loss: 0.2124 D_A_loss: -14.2345  D_B_loss: -21.4682
[16400/20000] adv_loss: 0.0257  recon_loss: 0.1717 encoding_loss: 0.0022 G_loss: 0.1997 D_A_loss: -11.6224  D_B_loss: -20.8077
[16500/20000] adv_loss: 0.0304  recon_loss: 0.1739 encoding_loss: 0.0023 G_loss: 0.2065 D_A_loss: -12.2905  D_B_loss: -21.3156
[16600/20000] adv_loss: 0.0289  recon_loss: 0.1680 encoding_loss: 0.0025 G_loss: 0.1993 D_A_loss: -12.4972  D_B_loss: -20.4863
[16700/20000] adv_loss: 0.0307  recon_loss: 0.1738 encoding_loss: 0.0026 G_loss: 0.2071 D_A_loss: -12.2735  D_B_loss: -20.9083
[16800/20000] adv_loss: 0.0262  recon_loss: 0.1704 encoding_loss: 0.0027 G_loss: 0.1993 D_A_loss: -12.9444  D_B_loss: -21.3499
[16900/20000] adv_loss: 0.0247  recon_loss: 0.1768 encoding_loss: 0.0024 G_loss: 0.2039 D_A_loss: -12.4784  D_B_loss: -21.5959
[17000/20000] adv_loss: 0.0254  recon_loss: 0.1695 encoding_loss: 0.0022 G_loss: 0.1972 D_A_loss: -12.1536  D_B_loss: -21.8945
[17100/20000] adv_loss: 0.0272  recon_loss: 0.1648 encoding_loss: 0.0021 G_loss: 0.1941 D_A_loss: -12.0534  D_B_loss: -21.2327
[17200/20000] adv_loss: 0.0273  recon_loss: 0.1741 encoding_loss: 0.0027 G_loss: 0.2040 D_A_loss: -12.3437  D_B_loss: -20.1606
[17300/20000] adv_loss: 0.0320  recon_loss: 0.1755 encoding_loss: 0.0027 G_loss: 0.2102 D_A_loss: -11.9851  D_B_loss: -21.2165
[17400/20000] adv_loss: 0.0264  recon_loss: 0.1605 encoding_loss: 0.0023 G_loss: 0.1892 D_A_loss: -12.0887  D_B_loss: -21.8521
[17500/20000] adv_loss: 0.0304  recon_loss: 0.1706 encoding_loss: 0.0025 G_loss: 0.2035 D_A_loss: -13.8096  D_B_loss: -20.2115
[17600/20000] adv_loss: 0.0292  recon_loss: 0.1685 encoding_loss: 0.0023 G_loss: 0.2000 D_A_loss: -11.6279  D_B_loss: -20.1569
[17700/20000] adv_loss: 0.0278  recon_loss: 0.1705 encoding_loss: 0.0019 G_loss: 0.2003 D_A_loss: -11.3740  D_B_loss: -20.7145
[17800/20000] adv_loss: 0.0303  recon_loss: 0.1672 encoding_loss: 0.0029 G_loss: 0.2004 D_A_loss: -12.6720  D_B_loss: -20.6704
[17900/20000] adv_loss: 0.0284  recon_loss: 0.1759 encoding_loss: 0.0019 G_loss: 0.2062 D_A_loss: -11.6906  D_B_loss: -20.1122
[18000/20000] adv_loss: 0.0283  recon_loss: 0.1770 encoding_loss: 0.0043 G_loss: 0.2095 D_A_loss: -12.6829  D_B_loss: -21.3194
[18100/20000] adv_loss: 0.0302  recon_loss: 0.1707 encoding_loss: 0.0023 G_loss: 0.2032 D_A_loss: -12.5079  D_B_loss: -20.5437
[18200/20000] adv_loss: 0.0272  recon_loss: 0.1652 encoding_loss: 0.0018 G_loss: 0.1943 D_A_loss: -12.0940  D_B_loss: -20.6839
[18300/20000] adv_loss: 0.0316  recon_loss: 0.1830 encoding_loss: 0.0035 G_loss: 0.2180 D_A_loss: -14.7120  D_B_loss: -21.7434
[18400/20000] adv_loss: 0.0279  recon_loss: 0.1719 encoding_loss: 0.0022 G_loss: 0.2020 D_A_loss: -12.2051  D_B_loss: -19.7538
[18500/20000] adv_loss: 0.0318  recon_loss: 0.1675 encoding_loss: 0.0028 G_loss: 0.2021 D_A_loss: -13.3307  D_B_loss: -20.6614
[18600/20000] adv_loss: 0.0186  recon_loss: 0.1714 encoding_loss: 0.0030 G_loss: 0.1930 D_A_loss: -15.8012  D_B_loss: -21.8533
[18700/20000] adv_loss: 0.0242  recon_loss: 0.1683 encoding_loss: 0.0029 G_loss: 0.1954 D_A_loss: -12.5730  D_B_loss: -20.4386
[18800/20000] adv_loss: 0.0244  recon_loss: 0.1775 encoding_loss: 0.0022 G_loss: 0.2042 D_A_loss: -11.4722  D_B_loss: -19.9679
[18900/20000] adv_loss: 0.0199  recon_loss: 0.1745 encoding_loss: 0.0027 G_loss: 0.1971 D_A_loss: -12.9563  D_B_loss: -21.3559
[19000/20000] adv_loss: 0.0217  recon_loss: 0.1667 encoding_loss: 0.0025 G_loss: 0.1909 D_A_loss: -12.7221  D_B_loss: -20.4991
[19100/20000] adv_loss: 0.0237  recon_loss: 0.1850 encoding_loss: 0.0032 G_loss: 0.2119 D_A_loss: -13.4279  D_B_loss: -20.2572
[19200/20000] adv_loss: 0.0220  recon_loss: 0.1679 encoding_loss: 0.0031 G_loss: 0.1930 D_A_loss: -13.5769  D_B_loss: -20.8411
[19300/20000] adv_loss: 0.0236  recon_loss: 0.1686 encoding_loss: 0.0021 G_loss: 0.1944 D_A_loss: -13.0230  D_B_loss: -21.0651
[19400/20000] adv_loss: 0.0185  recon_loss: 0.1676 encoding_loss: 0.0023 G_loss: 0.1884 D_A_loss: -12.7316  D_B_loss: -20.0561
[19500/20000] adv_loss: 0.0251  recon_loss: 0.1667 encoding_loss: 0.0028 G_loss: 0.1945 D_A_loss: -11.9865  D_B_loss: -19.7757
[19600/20000] adv_loss: 0.0233  recon_loss: 0.1696 encoding_loss: 0.0031 G_loss: 0.1960 D_A_loss: -12.4942  D_B_loss: -20.7676
[19700/20000] adv_loss: 0.0235  recon_loss: 0.1716 encoding_loss: 0.0026 G_loss: 0.1976 D_A_loss: -12.1943  D_B_loss: -19.8476
[19800/20000] adv_loss: 0.0226  recon_loss: 0.1637 encoding_loss: 0.0026 G_loss: 0.1889 D_A_loss: -12.0065  D_B_loss: -19.6304
[19900/20000] adv_loss: 0.0239  recon_loss: 0.1671 encoding_loss: 0.0023 G_loss: 0.1933 D_A_loss: -12.6808  D_B_loss: -19.5891
[20000/20000] adv_loss: 0.0189  recon_loss: 0.1697 encoding_loss: 0.0018 G_loss: 0.1903 D_A_loss: -12.6852  D_B_loss: -19.4677
Training finished.
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">gan</span><span class="o">.</span><span class="n">D_A</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../data/gan_da_rat.pt&quot;</span><span class="p">))</span>
<span class="n">gan</span><span class="o">.</span><span class="n">D_B</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../data/gan_db_rat.pt&quot;</span><span class="p">))</span>
<span class="n">gan</span><span class="o">.</span><span class="n">G_A</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../data/gan_ga_rat.pt&quot;</span><span class="p">))</span>
<span class="n">gan</span><span class="o">.</span><span class="n">G_B</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../data/gan_gb_rat.pt&quot;</span><span class="p">))</span>
<span class="n">gan</span><span class="o">.</span><span class="n">G_B</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../data/gan_gb_rat.pt&quot;</span><span class="p">))</span>
<span class="n">gan</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../data/gan_e_rat.pt&quot;</span><span class="p">))</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>&lt;All keys matched successfully&gt;
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">ctrl_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unst&quot;</span><span class="p">))]</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">gan</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">control_adata</span><span class="o">=</span><span class="n">ctrl_adata</span><span class="p">,</span>
                   <span class="n">cell_type_key</span><span class="o">=</span><span class="s2">&quot;species&quot;</span><span class="p">,</span>
                   <span class="n">condition_key</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pred&#39;</span>
<span class="n">treat_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">))]</span>
<span class="n">eval_adata3</span> <span class="o">=</span> <span class="n">ctrl_adata</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">treat_adata</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<span class="n">treatments</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">eval_adata3</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;unst&#39;</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Control&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LPS6&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;scPreGAN&quot;</span><span class="p">)</span>
<span class="n">eval_adata3</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">treatments</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">eval_adata3</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">eval_adata3</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;Treatment&quot;</span><span class="p">,</span> <span class="n">frameon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="s2">&quot;SF8B3.svg&quot;</span><span class="p">)</span>
<span class="n">CD4T</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">==</span><span class="n">cell</span><span class="p">]</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">CD4T</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;wilcoxon&quot;</span><span class="p">)</span>
<span class="n">diff_genes</span> <span class="o">=</span> <span class="n">CD4T</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;rank_genes_groups&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="s2">&quot;LPS6&quot;</span><span class="p">]</span>
<span class="n">r2_value</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">reg_mean_plot</span><span class="p">(</span>
<span class="n">eval_adata3</span><span class="p">,</span>
<span class="n">axis_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">},</span>
<span class="n">gene_list</span><span class="o">=</span><span class="n">diff_genes</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span>
<span class="n">top_100_genes</span> <span class="o">=</span> <span class="n">diff_genes</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span>
<span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;Predicted Expression&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;Real Expression&quot;</span><span class="p">},</span>
<span class="n">path_to_save</span><span class="o">=</span><span class="s2">&quot;../figures/SF8C3.svg&quot;</span><span class="p">,</span>
<span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;scPreGAN&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>Predicting data finished
WARNING: saving figure to file ../figures/pcaSF8B3.svg
</code></pre></div>

<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_39_1.png" /></p>
<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_39_2.png" /></p>
<h3 id="cellot-prediction">CellOT Prediction<a class="headerlink" href="#cellot-prediction" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">cellot_dir</span> <span class="o">=</span> <span class="s2">&quot;../data/cellot-pred&quot;</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cellot_dir</span><span class="si">}</span><span class="s2">/holdout-rat/model-cellot/evals_ood_data_space/imputed.h5ad&quot;</span><span class="p">)</span>
<span class="n">pred</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pred&#39;</span>
<span class="n">ctrl_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unst&quot;</span><span class="p">))]</span>
<span class="n">treat_adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[((</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">))]</span>

<span class="n">eval_adata4</span> <span class="o">=</span> <span class="n">ctrl_adata</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">treat_adata</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<span class="n">treatments</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">eval_adata4</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;unst&#39;</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Control&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;LPS6&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">treatments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;cellOT&quot;</span><span class="p">)</span>
<span class="n">eval_adata4</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">treatments</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">eval_adata4</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">eval_adata4</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;Treatment&quot;</span><span class="p">,</span> <span class="n">frameon</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="s2">&quot;SF8B3.svg&quot;</span><span class="p">)</span>
<span class="n">CD4T</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">==</span><span class="n">cell</span><span class="p">]</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span><span class="n">CD4T</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;wilcoxon&quot;</span><span class="p">)</span>
<span class="n">diff_genes</span> <span class="o">=</span> <span class="n">CD4T</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;rank_genes_groups&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="s2">&quot;LPS6&quot;</span><span class="p">]</span>
<span class="n">r2_value</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">reg_mean_plot</span><span class="p">(</span>
<span class="n">eval_adata4</span><span class="p">,</span>
<span class="n">axis_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;pred&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;LPS6&quot;</span><span class="p">},</span>
<span class="n">gene_list</span><span class="o">=</span><span class="n">diff_genes</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span>
<span class="n">top_100_genes</span> <span class="o">=</span> <span class="n">diff_genes</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span>
<span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;Predicted Expression&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;Real Expression&quot;</span><span class="p">},</span>
<span class="n">path_to_save</span><span class="o">=</span><span class="s2">&quot;../figures/SF8C3.svg&quot;</span><span class="p">,</span>
<span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;cellOT&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">WARNING</span><span class="o">:</span><span class="w"> </span><span class="n">saving</span><span class="w"> </span><span class="n">figure</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">../</span><span class="n">figures</span><span class="o">/</span><span class="n">pcaSF8B3</span><span class="o">.</span><span class="na">svg</span>
</code></pre></div>

<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_41_1.png" /></p>
<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_41_2.png" /></p>
<h1 id="supplementary-figure-8c">Supplementary Figure 8C<a class="headerlink" href="#supplementary-figure-8c" title="Permanent link">&para;</a></h1>
<div class="highlight"><pre><span></span><code><span class="c1"># df_list = []</span>
<span class="c1"># for cell in [&quot;rat&quot;, &quot;rabbit&quot;, &quot;pig&quot;]:</span>
<span class="c1">#     print(cell)</span>
<span class="c1">#     train_adata, test_adata = prepare_data(adata, &quot;species&quot;, &quot;condition&quot;, cell, &quot;LPS6&quot;, normalized = True)</span>

<span class="c1">#     vae = VIDR(train_adata, linear_decoder = False)</span>
<span class="c1"># #     vae.train(</span>
<span class="c1"># #     max_epochs=100,</span>
<span class="c1"># #     batch_size=128,</span>
<span class="c1"># #     early_stopping=True,</span>
<span class="c1"># #     early_stopping_patience=25)</span>

<span class="c1"># #     vae.save(f&quot;../../data/VAE_Binary_Prediction_IFNB_7000g_{cell}.pt&quot;)</span>
<span class="c1">#     vae = vae.load(f&quot;../../data/VAE_Species_Prediction_LPS_7000g_{cell}.pt/&quot;, train_adata)</span>

<span class="c1">#     vae_name = &quot;scGen&quot;</span>

<span class="c1">#     ctrl_key = &quot;unst&quot;</span>
<span class="c1">#     treat_key = &quot;LPS6&quot;</span>

<span class="c1">#     cell_type_to_predict = cell</span>
<span class="c1">#     cell_type_key = vae.scvi_setup_dict_[&quot;categorical_mappings&quot;][&quot;_scvi_labels&quot;][</span>
<span class="c1">#         &quot;original_key&quot;</span>
<span class="c1">#     ]</span>
<span class="c1">#     treatment_key = vae.scvi_setup_dict_[&quot;categorical_mappings&quot;][&quot;_scvi_batch&quot;][</span>
<span class="c1">#         &quot;original_key&quot;</span>
<span class="c1">#     ]</span>

<span class="c1">#     vae.adata.obs[&quot;species_condition&quot;] = adata.obs.species.astype(str) + adata.obs.condition.astype(str)</span>

<span class="c1">#     adata_bal = random_sample(vae.adata, &quot;species_condition&quot;, &quot;min&quot;)</span>
<span class="c1">#     adata_bal_ctrl = adata_bal[(adata_bal.obs[cell_type_key] == cell_type_to_predict) &amp; (adata_bal.obs[treatment_key] == ctrl_key)]</span>
<span class="c1">#     latent_bal =  vae.get_latent_representation(adata_bal)</span>
<span class="c1">#     latent_bal_adata = sc.AnnData(X=latent_bal, obs = adata_bal.obs.copy())</span>
<span class="c1">#     latent_cd = latent_bal_adata[(latent_bal_adata.obs[cell_type_key] == cell_type_to_predict) &amp; (latent_bal_adata.obs[treatment_key] == ctrl_key)].X</span>

<span class="c1">#     latent_mouse_cd = latent_bal_adata[(latent_bal_adata.obs[cell_type_key] == &quot;mouse&quot;) &amp; (latent_bal_adata.obs[treatment_key] == ctrl_key)].X</span>
<span class="c1">#     latent_mouse_trt = latent_bal_adata[(latent_bal_adata.obs[cell_type_key] == &quot;mouse&quot;) &amp; (latent_bal_adata.obs[treatment_key] == treat_key)].X</span>

<span class="c1">#     scgen_treat_delta = np.average(latent_mouse_trt,axis=0) - np.average(latent_mouse_cd,axis=0)</span>
<span class="c1">#     scgen_species_delta = np.average(latent_cd,axis=0) - np.average(latent_mouse_cd,axis=0)</span>

<span class="c1">#     treat_pred = 0.5*(scgen_species_delta + latent_mouse_trt + scgen_treat_delta + latent_cd)</span>
<span class="c1">#     predicted_cells = vae.module.generative(torch.Tensor(treat_pred))[&quot;px&quot;].cpu().detach().numpy()</span>
<span class="c1">#     pred = sc.AnnData(X=predicted_cells , obs=adata_bal_ctrl.obs.copy(), var=adata_bal_ctrl.var.copy(),obsm=adata_bal_ctrl.obsm.copy(),)</span>


<span class="c1">#     pred.obs[&quot;condition&quot;] = &#39;pred&#39;</span>
<span class="c1">#     ctrl_adata = adata[((adata.obs[&#39;species&#39;] == cell) &amp; (adata.obs[&quot;condition&quot;] == &quot;unst&quot;))]</span>
<span class="c1">#     treat_adata = adata[((adata.obs[&#39;species&#39;] == cell) &amp; (adata.obs[&quot;condition&quot;] == &quot;LPS6&quot;))]</span>
<span class="c1">#     eval_adata = ctrl_adata.concatenate(treat_adata, pred)</span>

<span class="c1">#     CD4T = adata[adata.obs[&quot;species&quot;] ==cell]</span>
<span class="c1">#     sc.tl.rank_genes_groups(CD4T, groupby=&quot;condition&quot;, method=&quot;wilcoxon&quot;)</span>
<span class="c1">#     diff_genes = CD4T.uns[&quot;rank_genes_groups&quot;][&quot;names&quot;][treat_key]</span>

<span class="c1">#     r2_df = calculate_r2_singledose(</span>
<span class="c1">#         eval_adata, cell,</span>
<span class="c1">#         vae_name, </span>
<span class="c1">#         &quot;condition&quot;, </span>
<span class="c1">#         {&quot;x&quot;:&quot;pred&quot;, &quot;y&quot;:&quot;LPS6&quot;}, </span>
<span class="c1">#         diff_genes=None, </span>
<span class="c1">#         random_sample_coef = 0.8,</span>
<span class="c1">#         n_iter = 100</span>
<span class="c1">#     )</span>
<span class="c1">#     df_list.append(r2_df)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">rat</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">batches</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;condition&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                 </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;species&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m52691</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Please</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">modify</span><span class="w"> </span><span class="n">adata</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">trained</span><span class="o">.</span><span class="w">                                                </span>
<span class="n">None</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Registered</span><span class="w"> </span><span class="n">keys</span><span class="p">:</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;X&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;batch_indices&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_mean&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_var&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;labels&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                           </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m52691</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="n">None</span>
<span class="n">rabbit</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">batches</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;condition&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                 </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;species&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m55007</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Please</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">modify</span><span class="w"> </span><span class="n">adata</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">trained</span><span class="o">.</span><span class="w">                                                </span>
<span class="n">None</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Registered</span><span class="w"> </span><span class="n">keys</span><span class="p">:</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;X&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;batch_indices&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_mean&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_var&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;labels&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                           </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m55007</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="n">None</span>
<span class="n">pig</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">batches</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;condition&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                 </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;species&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m57308</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Please</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">modify</span><span class="w"> </span><span class="n">adata</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">trained</span><span class="o">.</span><span class="w">                                                </span>
<span class="n">None</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Registered</span><span class="w"> </span><span class="n">keys</span><span class="p">:</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;X&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;batch_indices&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_mean&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_var&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;labels&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                           </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m57308</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="n">None</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># for cell in [&quot;rat&quot;, &quot;rabbit&quot;, &quot;pig&quot;]:</span>
<span class="c1">#     print(cell)</span>
<span class="c1">#     train_adata, test_adata = prepare_data(adata, &quot;species&quot;, &quot;condition&quot;, cell, &quot;LPS6&quot;, normalized = True)</span>

<span class="c1">#     vae = VIDR(train_adata, linear_decoder = False)</span>
<span class="c1"># #     vae.train(</span>
<span class="c1"># #     max_epochs=100,</span>
<span class="c1"># #     batch_size=128,</span>
<span class="c1"># #     early_stopping=True,</span>
<span class="c1"># #     early_stopping_patience=25)</span>

<span class="c1"># #     vae.save(f&quot;../../data/VAE_Binary_Prediction_IFNB_7000g_{cell}.pt&quot;)</span>
<span class="c1">#     vae = vae.load(f&quot;../../data/VAE_Species_Prediction_LPS_7000g_{cell}.pt/&quot;, train_adata)</span>

<span class="c1">#     vae_name = &quot;scVIDR&quot;</span>

<span class="c1">#     ctrl_key = &quot;unst&quot;</span>
<span class="c1">#     treat_key = &quot;LPS6&quot;</span>

<span class="c1">#     cell_type_to_predict = cell</span>
<span class="c1">#     cell_type_key = vae.scvi_setup_dict_[&quot;categorical_mappings&quot;][&quot;_scvi_labels&quot;][</span>
<span class="c1">#         &quot;original_key&quot;</span>
<span class="c1">#     ]</span>
<span class="c1">#     treatment_key = vae.scvi_setup_dict_[&quot;categorical_mappings&quot;][&quot;_scvi_batch&quot;][</span>
<span class="c1">#         &quot;original_key&quot;</span>
<span class="c1">#     ]</span>

<span class="c1">#     vae.adata.obs[&quot;species_condition&quot;] = adata.obs.species.astype(str) + adata.obs.condition.astype(str)</span>

<span class="c1">#     adata_bal = random_sample(vae.adata, &quot;species_condition&quot;, &quot;min&quot;)</span>
<span class="c1">#     adata_bal_ctrl = adata_bal[(adata_bal.obs[cell_type_key] == cell_type_to_predict) &amp; (adata_bal.obs[treatment_key] == ctrl_key)]</span>
<span class="c1">#     latent_bal =  vae.get_latent_representation(adata_bal)</span>
<span class="c1">#     latent_bal_adata = sc.AnnData(X=latent_bal, obs = adata_bal.obs.copy())</span>
<span class="c1">#     latent_cd = latent_bal_adata[(latent_bal_adata.obs[cell_type_key] == cell_type_to_predict) &amp; (latent_bal_adata.obs[treatment_key] == ctrl_key)].X</span>

<span class="c1">#     #Get deltas and control centroids for each cell tpye in the training dataset</span>
<span class="c1">#     deltas = []</span>
<span class="c1">#     latent_centroids = []</span>
<span class="c1">#     cell_types = np.unique(latent_bal_adata.obs[cell_type_key])</span>
<span class="c1">#     for cell_i in cell_types:</span>
<span class="c1">#         if cell_i != cell_type_to_predict:</span>
<span class="c1">#             latent_ctrl = latent_bal_adata[(latent_bal_adata.obs[cell_type_key] == cell_i) &amp; (latent_bal_adata.obs[treatment_key] == ctrl_key)].X</span>
<span class="c1">#             latent_treat = latent_bal_adata[(latent_bal_adata.obs[cell_type_key] == cell_i) &amp; (latent_bal_adata.obs[treatment_key] == treat_key)].X</span>
<span class="c1">#             deltas_i = np.average(latent_treat, axis = 0) - np.average(latent_ctrl, axis = 0)</span>
<span class="c1">#             deltas.append(deltas_i)</span>
<span class="c1">#             latent_centroids.append(np.average(latent_ctrl, axis = 0))</span>
<span class="c1">#     lr = LinearRegression()</span>
<span class="c1">#     reg = lr.fit(latent_centroids, deltas)</span>
<span class="c1">#     scvidr_delta = reg.predict([np.average(latent_cd, axis = 0)])[0]</span>

<span class="c1">#     treat_pred = scvidr_delta + latent_cd</span>
<span class="c1">#     predicted_cells = vae.module.generative(torch.Tensor(treat_pred))[&quot;px&quot;].cpu().detach().numpy()</span>
<span class="c1">#     pred = sc.AnnData(X=predicted_cells , obs=adata_bal_ctrl.obs.copy(), var=adata_bal_ctrl.var.copy(),obsm=adata_bal_ctrl.obsm.copy(),)</span>

<span class="c1">#     pred.obs[&quot;condition&quot;] = &#39;pred&#39;</span>
<span class="c1">#     ctrl_adata = adata[((adata.obs[&#39;species&#39;] == cell) &amp; (adata.obs[&quot;condition&quot;] == &quot;unst&quot;))]</span>
<span class="c1">#     treat_adata = adata[((adata.obs[&#39;species&#39;] == cell) &amp; (adata.obs[&quot;condition&quot;] == &quot;LPS6&quot;))]</span>
<span class="c1">#     eval_adata2 = ctrl_adata.concatenate(treat_adata, pred)</span>

<span class="c1">#     CD4T = adata[adata.obs[&quot;species&quot;] ==cell]</span>
<span class="c1">#     sc.tl.rank_genes_groups(CD4T, groupby=&quot;condition&quot;, method=&quot;wilcoxon&quot;)</span>
<span class="c1">#     diff_genes = CD4T.uns[&quot;rank_genes_groups&quot;][&quot;names&quot;][treat_key]</span>

<span class="c1">#     r2_df = calculate_r2_singledose(</span>
<span class="c1">#         eval_adata2, cell,</span>
<span class="c1">#         vae_name, </span>
<span class="c1">#         &quot;condition&quot;, </span>
<span class="c1">#         {&quot;x&quot;:&quot;pred&quot;, &quot;y&quot;:treat_key}, </span>
<span class="c1">#         diff_genes=None, </span>
<span class="c1">#         random_sample_coef = 0.8,</span>
<span class="c1">#         n_iter = 100</span>
<span class="c1">#     )</span>
<span class="c1">#     df_list.append(r2_df)</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code><span class="n">rat</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">batches</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;condition&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                 </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;species&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m52691</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Please</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">modify</span><span class="w"> </span><span class="n">adata</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">trained</span><span class="o">.</span><span class="w">                                                </span>
<span class="n">None</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Registered</span><span class="w"> </span><span class="n">keys</span><span class="p">:</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;X&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;batch_indices&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_mean&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_var&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;labels&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                           </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m52691</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="n">None</span>
<span class="n">rabbit</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">batches</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;condition&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                 </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;species&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m55007</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Please</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">modify</span><span class="w"> </span><span class="n">adata</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">trained</span><span class="o">.</span><span class="w">                                                </span>
<span class="n">None</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Registered</span><span class="w"> </span><span class="n">keys</span><span class="p">:</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;X&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;batch_indices&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_mean&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_var&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;labels&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                           </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m55007</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="n">None</span>
<span class="n">pig</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">batches</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;condition&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                 </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">labels</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s2">&quot;species&quot;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m57308</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Please</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">modify</span><span class="w"> </span><span class="n">adata</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">trained</span><span class="o">.</span><span class="w">                                                </span>
<span class="n">None</span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="w">                                                                                   </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Computing</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="n">prior</span><span class="w"> </span><span class="n">per</span><span class="w"> </span><span class="n">batch</span><span class="w">                                                                    </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Registered</span><span class="w"> </span><span class="n">keys</span><span class="p">:</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">[</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;X&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;batch_indices&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_mean&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;local_l_var&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">32</span><span class="n">m</span><span class="s1">&#39;labels&#39;</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="n">m</span><span class="p">]</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">                           </span>
<span class="err"></span><span class="p">[</span><span class="mi">34</span><span class="n">mINFO</span><span class="w">    </span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">Successfully</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="n">anndata</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">containing</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m57308</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">cells</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m6619</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">vars</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m2</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">batches</span><span class="p">,</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m4</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">labels</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w">      </span>
<span class="w">         </span><span class="n">proteins</span><span class="o">.</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">registered</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">categorical</span><span class="w"> </span><span class="n">covariates</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="err"></span><span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mi">36</span><span class="n">m0</span><span class="err"></span><span class="p">[</span><span class="mi">0</span><span class="n">m</span><span class="w"> </span><span class="n">extra</span><span class="w"> </span><span class="n">continuous</span><span class="w"> </span><span class="n">covariates</span><span class="o">.</span><span class="w">               </span>
<span class="n">None</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># r2_values_allCells_df = pd.concat(df_list)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># r2_values_allCells_df.to_csv(&quot;../data/Species_Model_Results.csv&quot;)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># r2_values_allCells_df = pd.read_csv(&quot;../data/Species_Model_Results.csv&quot;)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># r2_df_hvgs = r2_values_allCells_df[r2_values_allCells_df[&quot;Gene Set&quot;] == &quot;All HVGs&quot;]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># r2_df_hvgs = r2_values_allCells_df[r2_values_allCells_df[&quot;Gene Set&quot;] == &quot;All HVGs&quot;]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># order = [&#39;scVIDR&#39;, &#39;scGen&#39;,]# &#39;scPreGAN&#39;, &quot;CellOT&quot;]</span>
<span class="c1"># hue_order = [&quot;rat&quot;, &quot;rabbit&quot;, &quot;pig&quot;]</span>
<span class="c1"># ax = sns.boxplot(x = &quot;Model&quot;, y = &quot;R^2&quot;,  data = r2_df_hvgs, hue = &quot;Cell&quot;, order = order, hue_order = hue_order)</span>
<span class="c1"># pairs = [</span>
<span class="c1">#     ((&#39;scVIDR&#39;,&#39;rat&#39;), (&#39;scGen&#39;, &#39;rat&#39;)),</span>
<span class="c1">#     ((&#39;scVIDR&#39;, &#39;rabbit&#39;), (&#39;scGen&#39;, &#39;rabbit&#39;)),</span>
<span class="c1">#     ((&#39;scVIDR&#39;, &#39;pig&#39;), (&#39;scGen&#39;, &#39;pig&#39;))</span>
<span class="c1"># #    ((&#39;scVIDR&#39;,&#39;All HVGs&#39;), (&#39;scPreGAN&#39;, &#39;All HVGs&#39;)),</span>
<span class="c1"># #    ((&#39;scVIDR&#39;,&#39;DEGs&#39;), (&#39;scPreGAN&#39;, &#39;DEGs&#39;)),</span>
<span class="c1"># #    ((&#39;scVIDR&#39;, &#39;All HVGs&#39;), (&#39;CellOT&#39;, &#39;All HVGs&#39;)),</span>
<span class="c1"># #    ((&#39;scVIDR&#39;, &#39;DEGs&#39;), (&#39;CellOT&#39;, &#39;DEGs&#39;))</span>
<span class="c1"># ]</span>
<span class="c1"># annotator = Annotator(ax, pairs, data=r2_df_hvgs, x=&quot;Model&quot;, y=&quot;R^2&quot;, hue = &quot;Cell&quot;, order = order)</span>
<span class="c1"># annotator.configure(test=&#39;Mann-Whitney-gt&#39;, text_format=&#39;star&#39;, loc=&#39;outside&#39;)</span>
<span class="c1"># annotator.apply_and_annotate()</span>
<span class="c1"># plt.ylabel(r&quot;$R^2$ All HVGs&quot;)</span>
<span class="c1"># plt.savefig(&quot;../figures/SF8D.svg&quot;, bbox_inches = &quot;tight&quot;)</span>
<span class="c1"># plt.show()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>p-value annotation legend:
      ns: p &lt;= 1.00e+00
       <span class="gs">*: 1.00e-02 &lt; p &lt;= 5.00e-02</span>
<span class="gs">      *</span>*: 1.00e-03 &lt; p &lt;= 1.00e-02
     ***: 1.00e-04 &lt; p &lt;= 1.00e-03
    ****: p &lt;= 1.00e-04

scVIDR_pig vs. scGen_pig: Mann-Whitney-Wilcoxon test greater, P_val:1.000e+00 U_stat=0.000e+00
scVIDR_rat vs. scGen_rat: Mann-Whitney-Wilcoxon test greater, P_val:1.281e-34 U_stat=1.000e+04
scVIDR_rabbit vs. scGen_rabbit: Mann-Whitney-Wilcoxon test greater, P_val:1.281e-34 U_stat=1.000e+04
</code></pre></div>

<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_50_1.png" /></p>
<div class="highlight"><pre><span></span><code><span class="c1"># r2_df_degs = r2_values_allCells_df[r2_values_allCells_df[&quot;Gene Set&quot;] == &quot;DEGs&quot;]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># order = [&#39;scVIDR&#39;, &#39;scGen&#39;,]# &#39;scPreGAN&#39;, &quot;CellOT&quot;]</span>
<span class="c1"># hue_order = [&quot;rat&quot;, &quot;rabbit&quot;, &quot;pig&quot;]</span>
<span class="c1"># ax = sns.boxplot(x = &quot;Model&quot;, y = &quot;R^2&quot;,  data = r2_df_degs, hue = &quot;Cell&quot;, order = order, hue_order = hue_order)</span>
<span class="c1"># pairs = [</span>
<span class="c1">#     ((&#39;scVIDR&#39;,&#39;rat&#39;), (&#39;scGen&#39;, &#39;rat&#39;)),</span>
<span class="c1">#     ((&#39;scVIDR&#39;, &#39;rabbit&#39;), (&#39;scGen&#39;, &#39;rabbit&#39;)),</span>
<span class="c1">#     ((&#39;scVIDR&#39;, &#39;pig&#39;), (&#39;scGen&#39;, &#39;pig&#39;))</span>
<span class="c1"># #    ((&#39;scVIDR&#39;,&#39;All HVGs&#39;), (&#39;scPreGAN&#39;, &#39;All HVGs&#39;)),</span>
<span class="c1"># #    ((&#39;scVIDR&#39;,&#39;DEGs&#39;), (&#39;scPreGAN&#39;, &#39;DEGs&#39;)),</span>
<span class="c1"># #    ((&#39;scVIDR&#39;, &#39;All HVGs&#39;), (&#39;CellOT&#39;, &#39;All HVGs&#39;)),</span>
<span class="c1"># #    ((&#39;scVIDR&#39;, &#39;DEGs&#39;), (&#39;CellOT&#39;, &#39;DEGs&#39;))</span>
<span class="c1"># ]</span>
<span class="c1"># annotator = Annotator(ax, pairs, data=r2_df_degs, x=&quot;Model&quot;, y=&quot;R^2&quot;, hue = &quot;Cell&quot;, order = order)</span>
<span class="c1"># annotator.configure(test=&#39;Mann-Whitney-gt&#39;, text_format=&#39;star&#39;, loc=&#39;outside&#39;)</span>
<span class="c1"># annotator.apply_and_annotate()</span>
<span class="c1"># plt.ylabel(r&quot;$R^2$ All HVGs&quot;)</span>
<span class="c1"># plt.savefig(&quot;../figures/SF8D.svg&quot;, bbox_inches = &quot;tight&quot;)</span>
<span class="c1"># plt.show()</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>p-value annotation legend:
      ns: p &lt;= 1.00e+00
       <span class="gs">*: 1.00e-02 &lt; p &lt;= 5.00e-02</span>
<span class="gs">      *</span>*: 1.00e-03 &lt; p &lt;= 1.00e-02
     ***: 1.00e-04 &lt; p &lt;= 1.00e-03
    ****: p &lt;= 1.00e-04

scVIDR_pig vs. scGen_pig: Mann-Whitney-Wilcoxon test greater, P_val:1.000e+00 U_stat=0.000e+00
scVIDR_rat vs. scGen_rat: Mann-Whitney-Wilcoxon test greater, P_val:1.281e-34 U_stat=1.000e+04
scVIDR_rabbit vs. scGen_rabbit: Mann-Whitney-Wilcoxon test greater, P_val:1.000e+00 U_stat=0.000e+00
</code></pre></div>

<p><img alt="png" src="../SupplementalFigure8_files/SupplementalFigure8_52_1.png" /></p>
<div class="highlight"><pre><span></span><code>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "search.highlight", "search.share", "search.suggest", "content.code.annotate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>